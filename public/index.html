<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Real-Time Chat</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
    }

    .chat-container::-webkit-scrollbar,
    .summary-container::-webkit-scrollbar {
      width: 8px;
    }

    .chat-container::-webkit-scrollbar-track,
    .summary-container::-webkit-scrollbar-track {
      background: #f8fafc;
    }

    .chat-container::-webkit-scrollbar-thumb,
    .summary-container::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 4px;
    }

    .chat-container::-webkit-scrollbar-thumb:hover,
    .summary-container::-webkit-scrollbar-thumb:hover {
      background: #94a3b8;
    }

    #summary-content {
      white-space: pre-wrap;
    }
  </style>
</head>

<body class="bg-slate-100 flex flex-col h-screen">

  <!-- Join Screen -->
  <div id="join-screen" class="flex items-center justify-center h-screen">
    <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-sm">
      <h2 class="text-2xl font-bold text-slate-800 text-center mb-2">Join Secure Session</h2>
      <p class="text-slate-500 text-center mb-6">Enter the session name and code to join.</p>
      <form id="join-form" class="space-y-4">
        <div>
          <label for="session-name-input" class="block text-sm font-medium text-slate-700">Session Name</label>
          <input id="session-name-input" type="text" required
            class="mt-1 block w-full px-4 py-2 bg-slate-100 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition"
            placeholder="e.g., Q4-Planning">
        </div>
        <div>
          <label for="session-code-input" class="block text-sm font-medium text-slate-700">Session Code</label>
          <input id="session-code-input" type="password" required
            class="mt-1 block w-full px-4 py-2 bg-slate-100 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition"
            placeholder="Secret code for the session">
        </div>
        <div>
          <label for="username-input" class="block text-sm font-medium text-slate-700">Your Name</label>
          <input id="username-input" type="text" required
            class="mt-1 block w-full px-4 py-2 bg-slate-100 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition"
            placeholder="e.g., Alex">
        </div>
        <button id="join-button" type="submit"
          class="w-full bg-indigo-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition duration-200 flex items-center justify-center">
          Join Chat
        </button>
        <p id="error-message" class="text-sm text-red-600 text-center h-4"></p>
      </form>
    </div>
  </div>

  <!-- Chat Screen (Initially Hidden) -->
  <div id="chat-screen" class="flex flex-col h-screen hidden">
    <header class="bg-white shadow-md p-4 flex-shrink-0 z-10">
      <div class="max-w-7xl mx-auto flex justify-between items-center">
        <div>
          <h1 class="text-xl font-bold text-slate-800">Live Chat</h1>
          <p class="text-sm text-indigo-600 font-medium">Session: <span id="session-name-display"></span></p>
        </div>
        <button id="leave-button"
          class="text-sm bg-slate-200 text-slate-700 px-3 py-2 rounded-lg hover:bg-slate-300 transition">Change
          Session</button>
      </div>
    </header>

    <!-- Main Split-Screen Content -->
    <main class="flex-1 flex flex-col lg:flex-row max-w-7xl w-full mx-auto overflow-hidden">

      <!-- Left Panel: Chat -->
      <div class="flex-1 flex flex-col bg-white lg:w-1/2 lg:border-r lg:border-slate-200">
        <div id="chat-container" class="chat-container flex-1 p-4 md:p-6 space-y-4 overflow-y-auto">
          <!-- Messages will be dynamically inserted here -->
        </div>
        <div class="p-4 md:p-6 bg-slate-50 border-t border-slate-200 flex-shrink-0">
          <form id="message-form" class="flex items-center space-x-3">
            <input id="message-input" type="text" placeholder="Type your message..." autocomplete="off"
              class="flex-1 w-full px-4 py-2 bg-white border border-slate-300 rounded-full focus:outline-none focus:ring-2 focus:ring-indigo-500 transition"
              disabled>
            <button id="send-button" type="submit"
              class="bg-indigo-600 text-white rounded-full p-3 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 disabled:bg-indigo-300 transition"
              disabled>
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5">
                <line x1="22" y1="2" x2="11" y2="13"></line>
                <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
              </svg>
            </button>
          </form>
        </div>
      </div>

      <!-- Right Panel: AI Summary -->
      <div class="flex-1 flex flex-col bg-slate-50 lg:w-1/2">
        <div class="p-4 md:p-6 border-b border-slate-200 flex-shrink-0">
          <h2 class="text-lg font-bold text-slate-800">AI Summary</h2>
          <p class="text-sm text-slate-500">Converts the text conversation into a summary and news article.</p>
        </div>
        <div id="summary-container" class="summary-container flex-1 p-4 md:p-6 overflow-y-auto">
          <div id="summary-content" class="text-slate-600 space-y-4">
            <div class="flex justify-center items-center h-full text-slate-400">
              <p>Waiting for conversation to begin...</p>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script type="module">
    // --- Firebase Imports ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, doc, addDoc, onSnapshot, getDoc, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- DOM Elements ---
    const joinScreen = document.getElementById('join-screen');
    const chatScreen = document.getElementById('chat-screen');
    const joinForm = document.getElementById('join-form');
    const sessionNameInput = document.getElementById('session-name-input');
    const sessionCodeInput = document.getElementById('session-code-input');
    const usernameInput = document.getElementById('username-input');
    const sessionNameDisplay = document.getElementById('session-name-display');
    const leaveButton = document.getElementById('leave-button');
    const chatContainer = document.getElementById('chat-container');
    const messageForm = document.getElementById('message-form');
    const messageInput = document.getElementById('message-input');
    const sendButton = document.getElementById('send-button');
    const summaryContent = document.getElementById('summary-content');
    const errorMessage = document.getElementById('error-message');
    const joinButton = document.getElementById('join-button');

    let db;
    let auth;
    let currentUserId = null;
    let currentUsername = null;
    let currentSessionCode = null;
    let unsubscribeMessages = null;
    let unsubscribeSummary = null;
    let currentSessionName = null;

    const appId = typeof __app_id !== 'undefined' ? __app_id : 'ChArticle';

    let firebaseConfig;

    console.log("Chat App: Script starting.");

    function showError(message, error) {
      console.error(message, error || '');
      loader.innerHTML = `<div class="text-center text-red-500 p-4">${message}<br><span class="text-sm text-slate-500">Check the developer console for more details.</span></div>`;
      loader.style.display = 'flex';
      messageInput.disabled = true;
      sendButton.disabled = true;
      messageInput.placeholder = "Chat disabled due to an error.";
    }

    async function main() {
      try {
        if (typeof __firebase_config !== 'undefined') {
          // Use the config from the hosting environment when deployed
          firebaseConfig = JSON.parse(__firebase_config);
          console.log("Chat App: Using deployed Firebase config.");
        } else {
          // Use the local config for local testing
          console.log("Chat App: Loading local Firebase config from local_env.json...");
          const response = await fetch('./local_env.json');
          const data = await response.json();
          firebaseConfig = data;
          console.log("Chat App: Using local Firebase config.");
        }

        if (!firebaseConfig || !firebaseConfig.apiKey) {
          showError("Firebase configuration is missing or invalid. Please paste your config from the Firebase Console.");
          return;
        }

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);
        setLogLevel('debug');
        console.log("Chat App: Firebase initialized.");

        // Set up authentication listener
        onAuthStateChanged(auth, user => {
          if (user) {
            currentUserId = user.uid;
          } else {
            signInAnonymously(auth).catch(error => console.error("Anonymous sign-in failed:", error));
          }
        });

      } catch (error) {
        showError("Firebase initialization failed.", error);
      }
      loadStateFromLocalStorage();
    }

    async function verifyAndJoinSession(sessionName, sessionCode, username) {
      errorMessage.textContent = '';
      joinButton.disabled = true;
      joinButton.innerHTML = `<svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Verifying...`;

      try {
        const sessionDocRef = doc(db, `/accepted_sessions/${sessionName}`);
        const sessionDoc = await getDoc(sessionDocRef);

        if (sessionDoc.exists() && sessionDoc.data().session_code === sessionCode) {
          // Credentials are correct, proceed to join
          joinChatSession(sessionName, sessionCode, username);
        } else {
          // Credentials are wrong
          errorMessage.textContent = 'Invalid session name or code.';
        }
      } catch (error) {
        console.error("Error verifying session:", error);
        errorMessage.textContent = 'Could not verify session. Try again.';
      } finally {
        joinButton.disabled = false;
        joinButton.innerHTML = 'Join Chat';
      }
    }

    function loadStateFromLocalStorage() {
      const savedUsername = localStorage.getItem('chat_username');
      const savedSessionName = localStorage.getItem('chat_session_name');
      const savedSessionCode = localStorage.getItem('chat_session_code');
      if (savedUsername) usernameInput.value = savedUsername;
      if (savedSessionName) sessionNameInput.value = savedSessionName;
      if (savedSessionCode) sessionCodeInput.value = savedSessionCode;
      console.log("Chat App: Loaded state from localStorage.");
    }

    function joinChatSession(sessionName, sessionCode, username) {
      currentSessionName = sessionName;
      currentSessionCode = sessionCode;
      currentUsername = username;

      localStorage.setItem('chat_username', username);
      localStorage.setItem('chat_session_name', sessionName);
      localStorage.setItem('chat_session_code', sessionCode);

      sessionNameDisplay.textContent = sessionName;
      joinScreen.classList.add('hidden');
      chatScreen.classList.remove('hidden');

      enableChat();
      // Note: The path to the chat is based on the session CODE to keep it from being easily guessable.
      listenForMessages(sessionName);
      listenForSummary(sessionName);
    }


    function enableChat() {
      console.log("Chat App: Enabling chat UI.");
      messageInput.disabled = false;
      sendButton.disabled = false;
      messageInput.placeholder = "Type your message...";
    }

    function listenForMessages(sessionCode) {
      if (unsubscribeMessages) {
        unsubscribeMessages(); // Stop listening to the previous session
      }
      const messagesCollectionPath = `/artifacts/${appId}/public/data/chat_sessions/${sessionCode}/messages`;
      const messagesRef = collection(db, messagesCollectionPath);

      unsubscribeMessages = onSnapshot(messagesRef, (snapshot) => {
        const messages = [];
        snapshot.forEach(doc => messages.push({ id: doc.id, ...doc.data() }));
        messages.sort((a, b) => (a.timestamp?.toMillis() || 0) - (b.timestamp?.toMillis() || 0));
        renderMessages(messages);
      }, (error) => {
        console.error("Error listening for messages:", error);
        alert("Could not connect to this chat session. Check your security rules.");
      });
    }

    function renderMessages(messages) {
      chatContainer.innerHTML = ''; // Clear previous messages
      if (messages.length === 0) {
        const emptyState = document.createElement('div');
        emptyState.className = 'text-center text-slate-500 py-10';
        emptyState.textContent = 'No messages yet. Be the first to say something!';
        chatContainer.appendChild(emptyState);
        return;
      }

      messages.forEach(msg => {
        // const isCurrentUser = msg.userId === currentUserId;
        // TOD: This does not protect users from impersonating each other,
        // so we need to implement a better user identification mechanism.
        const isCurrentUser = msg.username === currentUsername;
        const wrapper = document.createElement('div');
        wrapper.className = `flex ${isCurrentUser ? 'justify-end' : 'justify-start'}`;

        const bubble = document.createElement('div');
        bubble.className = `max-w-xs md:max-w-md lg:max-w-lg p-3 rounded-2xl shadow-sm ${isCurrentUser ? 'bg-indigo-600 text-white rounded-br-lg' : 'bg-white text-slate-700 rounded-bl-lg'}`;

        const nameEl = document.createElement('p');
        nameEl.className = `text-xs font-semibold mb-1 ${isCurrentUser ? 'text-indigo-200' : 'text-slate-500'}`;
        nameEl.textContent = isCurrentUser ? 'You' : msg.username;

        const textEl = document.createElement('p');
        textEl.className = 'text-sm break-words';
        textEl.textContent = msg.text;

        bubble.appendChild(nameEl);
        bubble.appendChild(textEl);
        wrapper.appendChild(bubble);
        chatContainer.appendChild(wrapper);
      });
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    function listenForSummary(sessionCode) {
      if (unsubscribeSummary) unsubscribeSummary();

      const summaryDocPath = `/artifacts/${appId}/public/data/chat_sessions/${sessionCode}/summary/content`;
      const summaryRef = doc(db, summaryDocPath);

      setSummaryLoading();

      unsubscribeSummary = onSnapshot(summaryRef, (docSnap) => {
        if (docSnap.exists()) {
          const summaryData = docSnap.data();
          renderSummary(summaryData.content);
        } else {
          renderSummary("No summary has been generated yet. A summary will appear after a few messages have been sent.");
        }
      }, (error) => {
        console.error("Error listening for summary:", error);
        renderSummary("Could not load summary due to an error.");
      });
    }

    function setSummaryLoading() {
      summaryContent.innerHTML = `<div class="flex justify-center items-center h-full text-slate-400"><p>Generating summary...</p></div>`;
    }

    function renderSummary(content) {
      // Do the style updates on the compute server side
      summaryContent.innerHTML = `${content}`;
    }

    function leaveChatSession() {
      if (unsubscribeMessages) {
        unsubscribeMessages();
        unsubscribeMessages = null;
      }
      if (unsubscribeSummary) {
        unsubscribeSummary();
        unsubscribeSummary = null;
      }

      currentSessionCode = null;
      currentUsername = null;
      chatScreen.classList.add('hidden');
      joinScreen.classList.remove('hidden');
      chatContainer.innerHTML = '';
      summaryContent.innerHTML = '';
    }

    joinForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const sessionName = sessionNameInput.value.trim();
      const sessionCode = sessionCodeInput.value.trim();
      const username = usernameInput.value.trim();

      if (sessionName && sessionCode && username) {
        verifyAndJoinSession(sessionName, sessionCode, username);
      } else {
        errorMessage.textContent = 'All fields are required.';
      }
    });

    messageForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const messageText = messageInput.value.trim();

      if (messageText && currentUserId) {
        sendButton.disabled = true;
        const originalText = messageInput.value;
        messageInput.value = '';

        try {
          const messagesCollectionPath = `/artifacts/${appId}/public/data/chat_sessions/${currentSessionName}/messages`;
          console.log("Chat App: Sending message to", messagesCollectionPath);
          await addDoc(collection(db, messagesCollectionPath), {
            text: messageText,
            userId: currentUserId,
            username: currentUsername,
            timestamp: serverTimestamp()
          });

          console.log("Chat App: Message sent.");
        } catch (error) {
          console.log("Chat App: Failed to send message.");
          console.error("Error sending message:", error);
          alert('Could not send message. Please try again.');
          messageInput.value = originalText;
        } finally {
          sendButton.disabled = false;
          messageInput.focus();
        }
      }
    });

    leaveButton.addEventListener('click', leaveChatSession);

    main();
  </script>
</body>

</html>